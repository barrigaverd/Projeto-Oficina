{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-center">
  <div class="card shadow-sm w-100 rounded-3 mx-auto my-3" style="max-width: 45rem">
    <h4 class="card-header text-center fw-bold">Cadastro de Cliente</h4>
    <form class="card-body row g-4" method="post">

      <!-- Coluna 1 -->
      <div class="col-md-6">
        <div class="mb-3">
          <label for="nome_cliente" class="form-label">Nome:</label>
          <input class="form-control" type="text" id="nome_cliente" name="nome" required
            placeholder="Qual o nome do cliente?">
        </div>

        <div class="card mb-3">
          <div class="card-body p-3">
            <h6 class="card-title mb-2">Acesso do Cliente</h6>
            <div class="mb-3">
              <label for="username_cliente" class="form-label">Nome de usu√°rio:</label>
              <input class="form-control" type="text" id="username_cliente" name="username_cliente" required
                placeholder="Nome de usu√°rio...">
            </div>
            <div class="mb-3">
              <label for="password_cliente" class="form-label">Senha:</label>
              <input class="form-control" type="password" id="password_cliente" name="password_cliente" required
                placeholder="Digite a senha...">
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label for="telefone_celular" class="form-label">Telefone Celular:</label>
          <input class="form-control" type="tel" id="telefone_celular" name="telefone_celular" required
            placeholder="Telefone com DDD">
        </div>

        <div class="mb-3">
          <label for="telefone_auxiliar" class="form-label">Telefone Auxiliar:</label>
          <input class="form-control" type="tel" id="telefone_auxiliar" name="telefone_auxiliar"
            placeholder="Telefone com DDD">
        </div>

        <div class="mb-3">
          <label for="tipo_cliente" class="form-label">Tipo de Cliente:</label>
          <select class="form-select" id="tipo_cliente" name="tipo_cliente">
            <option selected value="">Selecione...</option>
            <option value="fisica">Pessoa F√≠sica</option>
            <option value="juridica">Pessoa Jur√≠dica</option>
          </select>
        </div>

        <div class="mb-3 d-none" id="campo_cpf">
          <label for="cpf" class="form-label">CPF:</label>
          <input type="text" class="form-control" id="cpf" name="cpf" placeholder="CPF">
        </div>

        <div class="mb-3 d-none" id="campo_cnpj">
          <label for="cnpj" class="form-label">CNPJ:</label>
          <input type="text" class="form-control" id="cnpj" name="cnpj" placeholder="CNPJ">
        </div>
      </div>

      <!-- Coluna 2 -->
      <div class="col-md-6">
        <h6 class="fw-bold mb-3">Endere√ßo</h6>

        <div class="mb-3">
          <label for="cep" class="form-label">CEP:</label>
          <input type="text" class="form-control" id="cep" name="cep" placeholder="CEP">
          <small id="cep-feedback" class="form-text text-muted"></small>
        </div>

        <div class="mb-3">
          <label for="logradouro" class="form-label">Logradouro:</label>
          <input type="text" class="form-control" id="logradouro" name="logradouro" placeholder="Rua, avenida, etc.">
        </div>

        <div class="mb-3">
          <label for="numero" class="form-label">N√∫mero:</label>
          <input type="text" class="form-control" id="numero" name="numero" placeholder="N√∫mero">
        </div>

        <div class="mb-3">
          <label for="complemento" class="form-label">Complemento:</label>
          <input type="text" class="form-control" id="complemento" name="complemento" placeholder="Apto, casa, etc.">
        </div>

        <div class="mb-3">
          <label for="bairro" class="form-label">Bairro:</label>
          <input type="text" class="form-control" id="bairro" name="bairro" placeholder="Bairro">
        </div>

        <div class="mb-3">
          <label for="cidade" class="form-label">Cidade:</label>
          <input type="text" class="form-control" id="cidade" name="cidade" placeholder="Cidade">
        </div>

        <div class="mb-3">
          <label for="estado" class="form-label">Estado:</label>
          <input type="text" class="form-control" id="estado" name="estado" placeholder="Estado">
        </div>

        <div class="mb-3">
          <label for="anotacoes" class="form-label">Anota√ß√µes:</label>
          <textarea class="form-control" id="anotacoes" name="anotacoes" rows="4"
            placeholder="Observa√ß√µes adicionais..."></textarea>
        </div>
      </div>

      <!-- Bot√£o -->
      <div class="col-12 text-center">
        <button class="btn btn-primary px-4" type="submit">üíæ Salvar Cliente</button>
      </div>
    </form>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tipoClienteSelect = document.getElementById('tipo_cliente');
    const campoCpf = document.getElementById('campo_cpf');
    const campoCnpj = document.getElementById('campo_cnpj');
    const cpfElement = document.getElementById('cpf');
    const cnpjElement = document.getElementById('cnpj');
    const telElement = document.getElementById('telefone_celular');
    const telAuxElement = document.getElementById('telefone_auxiliar');

    const cepInput = document.getElementById('cep');
    const logradouroInput = document.getElementById('logradouro');
    const bairroInput = document.getElementById('bairro');
    const cidadeInput = document.getElementById('cidade');
    const estadoInput = document.getElementById('estado');
    const cepFeedback = document.getElementById('cep-feedback');

    if (cpfElement) {
      const cpfMask = IMask(cpfElement, {
        mask: '000.000.000-00',
        maxLength: 11
      });
    }
    if (cepInput) {
      const cepMask = IMask(cepInput, {
        mask: '00.000-000',
        maxLength: 8
      });
    }

    const limparEndereco = () => {
      logradouroInput.value = '';
      bairroInput.value = '';
      cidadeInput.value = '';
      estadoInput.value = '';
    };
    // "Escuta" quando o usu√°rio sai do campo CEP
    cepInput.addEventListener('blur', () => {
        const cep = cepInput.value.replace(/\D/g, ''); // Remove tudo que n√£o for n√∫mero

        if (cep.length !== 8) {
            limparEndereco();
            return;
        }

        cepFeedback.textContent = 'Buscando...';

        // Faz a chamada para a API ViaCEP
        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(response => response.json())
            .then(data => {
                if (data.erro) {
                    cepFeedback.textContent = 'CEP n√£o encontrado.';
                    limparEndereco();
                } else {
                    cepFeedback.textContent = '';
                    logradouroInput.value = data.logradouro;
                    bairroInput.value = data.bairro;
                    cidadeInput.value = data.localidade;
                    estadoInput.value = data.uf;
                }
            })
            .catch(error => {
                cepFeedback.textContent = 'Erro ao buscar o CEP.';
                console.error('Erro:', error);
            });
    });


    if (cnpjElement) {
      const cnpjMask = IMask(cnpjElement, {
        mask: '00.000.000/0000-00',
        maxLength: 14
      });
    }
    if (telElement) {
      const telMask = IMask(telElement, {
        mask: '(00) 00000-0000',
        maxLength: 11
      });
    }
    if (telAuxElement) {
      const telAuxMask = IMask(telAuxElement, {
        mask: '(00) 00000-0000',
        maxLength: 11
      });
    }
    



    tipoClienteSelect.addEventListener('change', function () {
      campoCpf.classList.add('d-none');
      campoCnpj.classList.add('d-none');

      if (this.value === 'fisica') {
        campoCpf.classList.remove('d-none');
      } else if (this.value === 'juridica') {
        campoCnpj.classList.remove('d-none');
      }
    });
  });

  const nomeClienteInput = document.getElementById('nome_cliente');
  const usernameInput = document.getElementById('username_cliente');
  const passwordInput = document.getElementById('password_cliente');

  nomeClienteInput.addEventListener('blur', function () {
    if (usernameInput.value === '' && passwordInput.value === '') {
      const nomeCompleto = nomeClienteInput.value.trim().toLowerCase();
      if (nomeCompleto) {
        const partesNome = nomeCompleto.split(' ');
        const primeiroNome = partesNome[0].replace(/[^a-z0-9]/g, '');
        const anoAtual = new Date().getFullYear();
        let usernameSugerido = primeiroNome;
        if (partesNome.length > 1) {
          usernameSugerido += '.' + partesNome[partesNome.length - 1].charAt(0);
        }
        const senhaSugerida = primeiroNome + '@' + anoAtual;
        usernameInput.value = usernameSugerido;
        passwordInput.value = senhaSugerida;
      }
    }
  });
</script>
{% endblock %}