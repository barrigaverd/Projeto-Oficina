{% extends 'base.html' %}

{% block content %}
<div class="d-flex text-center mt-3">
    <div class="card shadow-sm w-100 rounded-3 mx-auto my-3">
        <h5 class="card-header">
            <strong>Informações do cliente</strong>
        </h5>
        <div class="card-body">
            <div class="card-title">Nome: {{ordem_servico.cliente.nome}}</div>
            <div class="card-text">Telefone Celular: {{ordem_servico.cliente.telefone_celular}}<br>Telefone auxiliar: {{ordem_servico.cliente.telefone_auxiliar}}</div>
            <div class="card-text">Endereço: {{ordem_servico.cliente.logradouro}}, Nº{{ordem_servico.cliente.numero}}, Bairro: {{ordem_servico.cliente.bairro}}<br>{{ordem_servico.cliente.cidade}} - {{ordem_servico.cliente.estado}}</div>
        </div>
    </div>
</div>

<div class="card">
    <h5 class="card-header text-center">Detalhes da OS #{{ordem_servico.numero_formatado}}</h5>
    
    <form class="card-body" method="post">
        <div class="mb-2">
        <label class="form-label" for="equipamento">Equipamento:</label>
        <input class="form-control" type="text" name="equipamento" value="{{ordem_servico.equipamento}}">
        </div>

        <div class="mb-2">
        <label class="form-label" for="marca">Marca:</label>
        <input class="form-control" type="text" name="marca" value="{{ordem_servico.marca}}">
        </div>

        <div class="mb-2">
        <label class="form-label" for="modelo">Modelo:</label>
        <input class="form-control" type="text" name="modelo" value="{{ordem_servico.modelo}}">
        </div>

        <div class="mb-2">
        <label class="form-label" for="defeito">Defeito:</label>
        <textarea class="form-control" name="defeito" id="defeito">{{ordem_servico.defeito}}</textarea>
        </div>
        <select class="form-select mb-3" name="status" aria-label="Selecione exemplo padrao">
            {% set status_opcoes = ['Pendente', 'Aguadando aprovação', 'Aprovado', 'Em andamento', 'Aguardando pagamento', 'Concluído', 'Garantia', 'Cancelado']%}
            <option selected>Status da OS:</option>
            {% for status_opcao in status_opcoes %}
            <option value="{{ status_opcao }}" 
              {% if status_opcao == ordem_servico.status %} selected {% endif %}>
            {{ status_opcao }}
            </option>
            {% endfor %}

        </select>

        <button class="btn btn-sm btn-primary" type="submit">Salvar OS</button>
        <a class="btn btn-sm btn-primary" href="{{url_for('deletar_os', id=ordem_servico.id)}}">Excluir</a>
        <a class="btn btn-sm btn-primary" href="{{url_for('gerar_pdf_os', os_id=ordem_servico.id)}}">PDF</a>
        <a class="btn btn-sm btn-primary" href="{{url_for('exibir_pdf_os', os_id=ordem_servico.id)}}">exibir PDF</a>
    </form>
</div>

<div class="card mt-4" id="fotos_equipamento">
    <h4 class="card-header">Fotos do Equipamento</h4>
    <div class="card-body">
        <div class="row row-cols-1 row-cols-md-3 g-4">

            {# Inicia o loop para cada foto associada a esta OS #}
            {% for foto in ordem_servico.fotos %}
            <div class="col">
                <div class="card h-100 shadow-sm">
                    
                    {# Cria o link para a imagem na pasta de uploads envolvendo a imagem #}
                    <a href="{{ url_for('static', filename='uploads/' + foto.nome_arquivo) }}" target="_blank">
                        <img src="{{ url_for('static', filename='uploads/' + foto.nome_arquivo) }}" 
                             class="card-img-top" 
                             alt="{{ foto.legenda or 'Foto da OS' }}" 
                             style="height: 200px; object-fit: cover;">
                    </a>
                    
                    {# Mostra a legenda se ela existir #}
                    {% if foto.legenda %}
                    <div class="card-body">
                        <p class="card-text">{{ foto.legenda }}</p>
                    </div>
                    {% endif %}

                    {# Adiciona um rodapé com um botão de excluir #}
                    <div class="card-footer text-end">
                        <form action="{{ url_for('remover_foto', foto_id=foto.id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-danger btn-sm">Excluir</button>
                        </form>
                    </div>

                </div>
            </div>
            {% endfor %}

        </div>
    </div>
</div>


<div class="card mt-3" id="adicionar-foto">
    <h4 class="card-header">Adicionar Fotos</h4>
    <form class="card-body" method="post" action="{{ url_for('adicionar_foto', os_id=ordem_servico.id) }}" enctype="multipart/form-data">
        <div class="row align-items-end">
            <div class="col-md-5">
                <label for="foto" class="form-label">Selecionar Foto</label>
                <input type="file" class="form-control" name="foto" required>
            </div>
            <div class="col-md-5">
                <label for="legenda" class="form-label">Legenda (opcional)</label>
                <input type="text" class="form-control" name="legenda" placeholder="Ex: Tela antes do reparo">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-info w-100">Enviar Foto</button>
            </div>
        </div>
    </form>
</div>


<div class="card mt-3">
    <h4 class="card-header text-center">Serviços na OS</h4>
    <table class="table justify-content-between table-striped table-sm text-center ">
        <thead>
            <tr>
                <th>Descrição</th>
                <th>Qtd</th>
                <th>Preço Unit.</th>
                <th>Subtotal</th>
                <th>Ação</th>
            </tr>
        </thead>
        <tbody>
            {% for item in ordem_servico.itens_servico %}
            <tr class="card-body">
                <td>{{ item.servico.descricao_servico }}</td>
                <td>{{ item.quantidade }}</td>
                <td>R$ {{ "%.2f"|format(item.preco_cobrado|float) }}</td>
                <td>R$ {{ "%.2f"|format((item.quantidade * item.preco_cobrado)|float) }}</td>
                <td>
                    <a class="btn btn-danger btn-sm" href="{{url_for('remover_servico', id=item.id)}}">Remover</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card mt-3" id="adicionar_servico">
    <h4 class="card-header text-center">Adicionar Serviço</h4>
    <form method="post" action="{{ url_for('adicionar_servico', os_id=ordem_servico.id) }}">
        <div class="card-body">
            <label for="servico" class="form-label">Serviço:</label>
            <select name="servico_id" class="form-select" required>
                <option value="">Selecione um serviço...</option>
                {% for servico in lista_servicos %}
                    <option value="{{ servico.id }}">{{ servico.descricao_servico }} - R$ {{ "%.2f"|format(servico.preco_unitario|float) }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="row card-body">
            <div class="col-md-6 mb-3">
                <label for="quantidade" class="form-label">Quantidade</label>
                <input type="number" class="form-control" name="quantidade" value="1" required>
            </div>
            <div class="col-md-6 mb-3">
                <label for="preco_cobrado" class="form-label">Preço Cobrado (R$)</label>
                <input type="text" class="form-control" name="preco_cobrado" placeholder="Deixe em branco para usar o preço padrão">
            </div>
        </div>
        <button type="submit" class="btn btn-success btn-sm mb-3 mx-3">Adicionar Serviço a OS</button>
        <a class="btn btn-secondary btn-sm mb-3 mx-3" href="{{url_for('cadastrar_servico')}}">Cadastrar novo serviço</a>
    </form>

</div>

<div class="card mt-3">
    <h4 class="card-header text-center">Peças na OS</h4>
    <table class="table justify-content-between table-striped table-sm text-center">
        <thead>
            <tr>
                <th>Nome da Peça</th>
                <th>Qtd</th>
                <th>Preço Unit.</th>
                <th>Subtotal</th>
                <th>Ação</th>
            </tr>
        </thead>
        <tbody>
            {% for item in ordem_servico.itens_peca %}
            <tr>
                <td>{{ item.peca.nome_peca }}</td>
                <td>{{ item.quantidade }}</td>
                <td>R$ {{ "%.2f"|format(item.preco_cobrado|float) }}</td>
                <td>R$ {{ "%.2f"|format((item.quantidade * item.preco_cobrado)|float) }}</td>
                <td>
                    <a class="btn btn-danger btn-sm" href="{{url_for('remover_peca', id=item.id)}}">Remover</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div class="card mt-3" id="adicionar_peca">
    <h4 class="card-header text-center">Adicionar Peça</h4>
    <form method="post" action="{{ url_for('adicionar_peca', os_id=ordem_servico.id) }}">
        <div class="card-body">
            <label for="peca" class="form-label">Peça:</label>
            <select name="peca_id" class="form-select" required>
                <option value="">Selecione uma peça...</option>
                {% for peca in lista_pecas %}
                    <option value="{{ peca.id }}">{{ peca.nome_peca }} - R$ {{ "%.2f"|format(peca.preco_unitario|float) }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="row card-body">
            <div class="col-md-6 mb-3">
                <label for="quantidade" class="form-label">Quantidade</label>
                <input type="number" class="form-control" name="quantidade" value="1" required>
            </div>
            <div class="col-md-6 mb-3">
                <label for="preco_cobrado" class="form-label">Preço Cobrado (R$)</label>
                <input type="text" class="form-control" name="preco_cobrado" placeholder="Deixe em branco para usar o preço padrão">
            </div>
        </div>
        <button type="submit" class="btn btn-success btn-sm mb-3 mx-3">Adicionar Peça a OS</button>
        <a class="btn btn-secondary btn-sm mb-3 mx-3" href="{{url_for('cadastrar_peca')}}">Cadastrar nova peça</a>
    </form>
</div>

{% endblock %}
