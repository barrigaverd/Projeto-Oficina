{% extends 'base.html' %}
{% block content %}

<!-- Informa√ß√µes do Cliente -->
<div class="d-flex justify-content-center mt-3">
  <div class="card shadow-sm w-100 rounded-3 mx-auto" style="max-width: 60rem;">
    <h5 class="card-header text-center fw-bold">Informa√ß√µes do Cliente</h5>
    <div class="card-body">
      <p class="mb-1"><strong>Nome:</strong> {{ordem_servico.cliente.nome}}</p>
      <p class="mb-1"><strong>Telefone Celular:</strong> {{ordem_servico.cliente.telefone_celular}}</p>
      <p class="mb-1"><strong>Telefone Auxiliar:</strong> {{ordem_servico.cliente.telefone_auxiliar}}</p>
      <p class="mb-0"><strong>Endere√ßo:</strong> {{ordem_servico.cliente.logradouro}},
        N¬∫{{ordem_servico.cliente.numero}},
        Bairro: {{ordem_servico.cliente.bairro}}, {{ordem_servico.cliente.cidade}} - {{ordem_servico.cliente.estado}}
      </p>
    </div>
  </div>
</div>

<!-- Detalhes da OS -->
<div class="card mt-4 shadow-sm">
  <h5 class="card-header text-center fw-bold">Detalhes da OS #{{ordem_servico.numero_formatado}}</h5>
  <form class="card-body row g-3" method="post">
    <div class="col-md-6">
      <label class="form-label" for="tecnico_responsavel">T√©cnico respons√°vel:</label>
      <input class="form-control" type="text" id="tecnico_responsavel" name="tecnico_responsavel"
        value="{{ordem_servico.tecnico_responsavel or ''}}">
    </div>
    <div class="col-md-6">
      <label for="equipamento" class="form-label">Equipamento</label>
      <input class="form-control" type="text" name="equipamento" value="{{ordem_servico.equipamento}}">
    </div>
    <div class="col-md-6">
      <label for="marca" class="form-label">Marca</label>
      <input class="form-control" type="text" name="marca" value="{{ordem_servico.marca}}">
    </div>
    <div class="col-md-6">
      <label for="modelo" class="form-label">Modelo</label>
      <input class="form-control" type="text" name="modelo" value="{{ordem_servico.modelo}}">
    </div>
    <div class="col-md-6">
      <label class="form-label" for="numero_de_serie">Numero de s√©rie:</label>
      <input class="form-control" type="text" id="numero_de_serie" name="numero_de_serie"
        value="{{ordem_servico.numero_de_serie or ''}}">
    </div>
    <div class="col-12">
      <label for="defeito" class="form-label">Defeito Relatado</label>
      <textarea class="form-control" name="defeito" id="defeito" rows="3">{{ordem_servico.defeito}}</textarea>
    </div>
    <div class="col-12">
      <label class="form-label" for="problema_constatado">Problema constatado:</label>
      <textarea class="form-control" id="problema_constatado" name="problema_constatado"
        rows="3">{{ordem_servico.problema_constatado or ''}}</textarea>
    </div>
    <div class="col-12">
      <label class="form-label" for="servico_executado">Servi√ßo executado:</label>
      <textarea class="form-control" id="servico_executado" name="servico_executado"
        rows="3">{{ordem_servico.servico_executado or ''}}</textarea>
    </div>
    <div class="col-12">
      <label class="form-label" for="observacoes_cliente">Observa√ß√µes (Vis√≠vel para o cliente):</label>
      <textarea class="form-control" id="observacoes_cliente" name="observacoes_cliente"
        rows="3">{{ordem_servico.observacoes_cliente or ''}}</textarea>
    </div>
    <div class="col-12">
      <label class="form-label" for="observacoes_internas">Observa√ß√µes (N√£o vis√≠vel para o cliente):</label>
      <textarea class="form-control" id="observacoes_internas" name="observacoes_internas"
        rows="3">{{ordem_servico.observacoes_internas or ''}}</textarea>
    </div>
    <div class="col-md-6">
      <label for="status" class="form-label">Status da OS</label>
      <select class="form-select" name="status" id="status">
        {% set status_opcoes = ['Pendente','Aguardando aprova√ß√£o','Aprovado','Em andamento','Aguardando
        pagamento','Conclu√≠do','Garantia','Cancelado'] %}
        {% for status_opcao in status_opcoes %}
        <option value="{{ status_opcao }}" {% if status_opcao==ordem_servico.status %}selected{% endif %}>
          {{ status_opcao }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 text-center">
      <button class="btn btn-success btn-sm" type="submit">üíæ Salvar</button>
      <a class="btn btn-danger btn-sm" href="{{url_for('deletar_os', id=ordem_servico.id)}}">üóë Excluir</a>
      <a class="btn btn-secondary btn-sm" href="{{url_for('gerar_pdf_os', os_id=ordem_servico.id)}}">üìÑ PDF</a>
      <a class="btn btn-info btn-sm" href="{{url_for('exibir_pdf_os', os_id=ordem_servico.id)}}" target="_blank">üëÅ
        Exibir PDF</a>
    </div>
  </form>
</div>

<!-- Fotos -->
<div class="card mt-4" id="fotos_equipamento">
  <h4 class="card-header text-center fw-bold">üì∑ Fotos do Equipamento</h4>
  <div class="card-body">
    <div class="row row-cols-1 row-cols-md-3 g-3">
      {% for foto in ordem_servico.fotos %}
      <div class="col">
        <div class="card h-100 shadow-sm">
          <a href="{{ url_for('static', filename='uploads/' + foto.nome_arquivo) }}" target="_blank">
            <img src="{{ url_for('static', filename='uploads/' + foto.nome_arquivo) }}" class="card-img-top"
              alt="{{ foto.legenda or 'Foto da OS' }}" style="height: 200px; object-fit: cover;">
          </a>
          {% if foto.legenda %}
          <div class="card-body p-2">
            <p class="small m-0">{{ foto.legenda }}</p>
          </div>
          {% endif %}
          <div class="card-footer text-end">
            <form action="{{ url_for('remover_foto', foto_id=foto.id) }}" method="post" class="d-inline">
              <button type="submit" class="btn btn-outline-danger btn-sm">Remover</button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Adicionar Foto -->
<div class="card mt-3" id="adicionar-foto">
  <h4 class="card-header text-center fw-bold">‚ûï Adicionar Foto</h4>
  <form class="card-body row g-3" method="post" action="{{ url_for('adicionar_foto', os_id=ordem_servico.id) }}"
    enctype="multipart/form-data">
    <div class="col-md-5">
      <label for="foto" class="form-label">Selecionar Foto</label>
      <input type="file" class="form-control" name="foto" required>
    </div>
    <div class="col-md-5">
      <label for="legenda" class="form-label">Legenda (opcional)</label>
      <input type="text" class="form-control" name="legenda" placeholder="Ex: Tela antes do reparo">
    </div>
    <div class="col-md-2 d-grid">
      <button type="submit" class="btn btn-info">Enviar</button>
    </div>
  </form>
</div>

<!-- Servi√ßos -->
<div class="card mt-3">
  <h4 class="card-header text-center fw-bold">üõ† Servi√ßos na OS</h4>
  <table class="table table-striped table-sm text-center mb-0">
    <thead>
      <tr>
        <th>Descri√ß√£o</th>
        <th>Qtd</th>
        <th>Pre√ßo Unit.</th>
        <th>Subtotal</th>
        <th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody>
      {% for item in ordem_servico.itens_servico %}
      <tr>
        <td>{{ item.servico.descricao_servico }}</td>
        <td>{{ item.quantidade }}</td>
        <td>R$ {{ "%.2f"|format(item.preco_cobrado|float) }}</td>
        <td>R$ {{ "%.2f"|format((item.quantidade * item.preco_cobrado)|float) }}</td>
        <td><a class="btn btn-danger btn-sm" href="{{url_for('remover_servico', id=item.id)}}">Remover</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Adicionar Servi√ßo -->
<div class="card mt-3" id="adicionar_servico">
  <h4 class="card-header text-center fw-bold">‚ûï Adicionar Servi√ßo</h4>
  <form class="card-body row g-3" method="post" action="{{ url_for('adicionar_servico', os_id=ordem_servico.id) }}">
    <div class="col-12">
      <label for="servico" class="form-label">Servi√ßo:</label>
      <select name="servico_id" class="form-select" required>
        <option value="">Selecione um servi√ßo...</option>
        {% for servico in lista_servicos %}
        <option value="{{ servico.id }}">{{ servico.descricao_servico }} - R$ {{
          "%.2f"|format(servico.preco_unitario|float) }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6">
      <label for="quantidade" class="form-label">Quantidade</label>
      <input type="number" class="form-control" name="quantidade" value="1" required>
    </div>
    <div class="col-md-6">
      <label for="preco_cobrado" class="form-label">Pre√ßo Cobrado (R$)</label>
      <input type="text" class="form-control" name="preco_cobrado"
        placeholder="Deixe em branco para usar o pre√ßo padr√£o">
    </div>
    <div class="col-12 text-center">
      <button type="submit" class="btn btn-success btn-sm">Adicionar</button>
      <a class="btn btn-secondary btn-sm" href="{{url_for('cadastrar_servico')}}">Novo Servi√ßo</a>
    </div>
  </form>
</div>

<!-- Pe√ßas -->
<div class="card mt-3">
  <h4 class="card-header text-center fw-bold">üîß Pe√ßas na OS</h4>
  <table class="table table-striped table-sm text-center mb-0">
    <thead>
      <tr>
        <th>Nome da Pe√ßa</th>
        <th>Qtd</th>
        <th>Pre√ßo Unit.</th>
        <th>Subtotal</th>
        <th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody>
      {% for item in ordem_servico.itens_peca %}
      <tr>
        <td>{{ item.peca.nome_peca }}</td>
        <td>{{ item.quantidade }}</td>
        <td>R$ {{ "%.2f"|format(item.preco_cobrado|float) }}</td>
        <td>R$ {{ "%.2f"|format((item.quantidade * item.preco_cobrado)|float) }}</td>
        <td><a class="btn btn-danger btn-sm" href="{{url_for('remover_peca', id=item.id)}}">Remover</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Adicionar Pe√ßa -->
<div class="card mt-3" id="adicionar_peca">
  <h4 class="card-header text-center fw-bold">‚ûï Adicionar Pe√ßa</h4>
  <form class="card-body row g-3" method="post" action="{{ url_for('adicionar_peca', os_id=ordem_servico.id) }}">
    <div class="col-12">
      <label for="peca" class="form-label">Pe√ßa:</label>
      <select name="peca_id" class="form-select" required>
        <option value="">Selecione uma pe√ßa...</option>
        {% for peca in lista_pecas %}
        <option value="{{ peca.id }}">{{ peca.nome_peca }} - R$ {{ "%.2f"|format(peca.preco_unitario|float) }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6">
      <label for="quantidade" class="form-label">Quantidade</label>
      <input type="number" class="form-control" name="quantidade" value="1" required>
    </div>
    <div class="col-md-6">
      <label for="preco_cobrado" class="form-label">Pre√ßo Cobrado (R$)</label>
      <input type="text" class="form-control" name="preco_cobrado"
        placeholder="Deixe em branco para usar o pre√ßo padr√£o">
    </div>
    <div class="col-12 text-center">
      <button type="submit" class="btn btn-success btn-sm">Adicionar</button>
      <a class="btn btn-secondary btn-sm" href="{{url_for('cadastrar_peca')}}">Nova Pe√ßa</a>
    </div>
  </form>
</div>

{% endblock %}