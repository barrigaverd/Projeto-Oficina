{% extends 'base_publica.html' %}

{% block content %}

<div class="text-md-start">
  <button class="btn btn-secondary btn-sm px-4" onclick="retornar()">Voltar</button>
</div>
<!-- Informações do Cliente -->
<div class="card shadow-sm text-center mt-3">
  <h5 class="card-header fw-bold">Informações do Cliente</h5>
  <div class="card-body">
    <p class="mb-1"><strong>Nome:</strong> {{ ordem_servico.cliente.nome }}</p>
    <p class="mb-1">
      <strong>Telefone Celular:</strong> {{ ordem_servico.cliente.telefone_celular }} <br>
      <strong>Telefone Auxiliar:</strong> {{ ordem_servico.cliente.telefone_auxiliar }}
    </p>
    <p class="mb-0">
      <strong>Endereço:</strong> {{ ordem_servico.cliente.logradouro }}, Nº {{ ordem_servico.cliente.numero }},
      Bairro: {{ ordem_servico.cliente.bairro }} <br>
      {{ ordem_servico.cliente.cidade }} - {{ ordem_servico.cliente.estado }}
    </p>
  </div>
</div>

<!-- Detalhes da OS -->
<div class="card shadow-sm text-center mt-4">
  <h5 class="card-header fw-bold">Detalhes da OS #{{ ordem_servico.numero_formatado }}</h5>
  <div class="card-body">
    <p><strong>Equipamento:</strong> {{ ordem_servico.equipamento }}</p>
    <p><strong>Marca:</strong> {{ ordem_servico.marca }}</p>
    <p><strong>Modelo:</strong> {{ ordem_servico.modelo }}</p>
    <p><strong>Defeito:</strong> {{ ordem_servico.defeito }}</p>
    <p>
      <strong>Status em tempo real:</strong>
      <span id="status" class="badge bg-secondary align-middle">
        {{ ordem_servico.status }}
      </span>
    </p>
  </div>
</div>

<!-- Fotos -->
<div class="card shadow-sm mt-4" id="fotos_equipamento">
  <h5 class="card-header fw-bold">Fotos do Equipamento</h5>
  <div class="card-body">
    <div class="row row-cols-1 row-cols-md-3 g-4">
      {% for foto in ordem_servico.fotos %}
      <div class="col">
        <div class="card h-100 shadow-sm">
          <a href="{{ url_for('static', filename='uploads/' + foto.nome_arquivo) }}" target="_blank">
            <img src="{{ url_for('static', filename='uploads/' + foto.nome_arquivo) }}" class="card-img-top"
              alt="{{ foto.legenda or 'Foto da OS' }}" style="height: 200px; object-fit: cover;">
          </a>
          {% if foto.legenda %}
          <div class="card-body">
            <p class="card-text">{{ foto.legenda }}</p>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Serviços -->
<div class="card shadow-sm mt-4">
  <h5 class="card-header text-center fw-bold">Serviços na OS</h5>
  <div class="table-responsive">
    <table class="table table-striped align-middle mb-0">
      <thead class="table-dark text-center">
        <tr>
          <th>Descrição</th>
          <th>Quantidade</th>
          <th>Preço Unit. (R$)</th>
          <th>Subtotal (R$)</th>
        </tr>
      </thead>
      <tbody>
        {% for item in ordem_servico.itens_servico %}
        <tr class="text-center">
          <td>{{ item.servico.descricao_servico }}</td>
          <td>{{ item.quantidade }}</td>
          <td>R$ {{ "%.2f"|format(item.preco_cobrado|float) }}</td>
          <td class="fw-bold text-success">
            R$ {{ "%.2f"|format((item.quantidade * item.preco_cobrado)|float) }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Peças -->
<div class="card shadow-sm mt-4">
  <h5 class="card-header text-center fw-bold">Peças na OS</h5>
  <div class="table-responsive">
    <table class="table table-striped align-middle mb-0">
      <thead class="table-dark text-center">
        <tr>
          <th>Descrição</th>
          <th>Quantidade</th>
          <th>Preço Unit. (R$)</th>
          <th>Subtotal (R$)</th>
        </tr>
      </thead>
      <tbody>
        {% for peca in ordem_servico.itens_peca %}
        <tr class="text-center">
          <td>{{ peca.peca.nome_peca }}</td>
          <td>{{ peca.quantidade }}</td>
          <td>R$ {{ "%.2f"|format(peca.preco_cobrado|float) }}</td>
          <td class="fw-bold text-success">
            R$ {{ "%.2f"|format((peca.quantidade * peca.preco_cobrado)|float) }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Total -->
<div class="card shadow-sm text-center mt-4">
  <h5 class="card-header fw-bold">Total da OS</h5>
  <div class="card-body">
    <span class="fs-5 fw-bold text-success">
      R$ {{ "%.2f"|format(ordem_servico.valor_calculado|float) }}
    </span>
  </div>
</div>

<script>
  const status = document.querySelector("#status");
  if (status && status.textContent.trim() === "Concluído") {
    status.classList.replace("bg-secondary", "bg-success");
    status.classList.add("text-white");
  }
</script>

{% endblock %}